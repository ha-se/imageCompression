name: Kintone画像圧縮バッチ

on:
  schedule:
    - cron: '0 21 * * *' # 毎日 JST 6:00 (UTC 21:00)
  workflow_dispatch:
    inputs:
      batch_size:
        description: '処理レコード上限 (0 = 無制限)'
        required: false
        default: '0'
      enable_delete:
        description: '古い画像の削除を有効化'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      timeout:
        description: 'タイムアウト（分）'
        required: false
        default: '60'

concurrency:
  group: kintone-image-batch
  cancel-in-progress: false

jobs:
  compress:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout || '60') }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: バッチ実行
        run: npx tsx src/index.ts
        env:
          KINTONE_BASE_URL: ${{ secrets.KINTONE_BASE_URL }}
          KINTONE_API_TOKEN: ${{ secrets.KINTONE_API_TOKEN }}
          KINTONE_APP_ID: ${{ secrets.KINTONE_APP_ID }}
          KINTONE_ATTACHMENT_FIELD: ${{ secrets.KINTONE_ATTACHMENT_FIELD }}
          MAX_FILE_SIZE_MB: ${{ vars.MAX_FILE_SIZE_MB || '1' }}
          TARGET_QUALITY: ${{ vars.TARGET_QUALITY || '80' }}
          RETENTION_MONTHS: ${{ vars.RETENTION_MONTHS || '3' }}
          ENABLE_DELETE_OLD_IMAGES: ${{ github.event.inputs.enable_delete || vars.ENABLE_DELETE_OLD_IMAGES || 'false' }}
          MAX_API_CALLS: ${{ vars.MAX_API_CALLS || '9000' }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || vars.BATCH_SIZE || '0' }}
